"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NavigationProvider = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const navigation_context_1 = __importDefault(require("./navigation-context"));
const bus_1 = require("../bus");
const View = ({ children }) => {
    return (0, jsx_runtime_1.jsx)("view", { children: children });
};
/**
 * @ignore
 */
const NavigationProvider = ({ root }) => {
    const [navStack, setNavStack] = (0, react_1.useState)([root]);
    const pendingShutdown = (0, react_1.useRef)(false);
    const pop = () => {
        if (pendingShutdown.current)
            return;
        // we ask Vicinae to pop the current view, but we need to wait
        // for the pop-view event to be fired in order to dismount it from
        // our local view stack: otherwise Vicinae might miss a render.
        bus_1.bus.request("ui.popView", {});
    };
    const push = (node) => {
        if (pendingShutdown.current)
            return;
        bus_1.bus.request("ui.pushView", {}).then(() => {
            setNavStack((cur) => [...cur, node]);
        });
    };
    (0, react_1.useEffect)(() => {
        if (pendingShutdown.current && navStack.length === 0) {
            process.exit(0);
        }
    }, [navStack]);
    (0, react_1.useEffect)(() => {
        const shutdown = bus_1.bus.subscribe("shutdown", () => {
            pendingShutdown.current = true;
            setNavStack([]);
        });
        const listener = bus_1.bus.subscribe("pop-view", () => {
            setNavStack((cur) => cur.slice(0, -1));
        });
        return () => {
            shutdown.unsubscribe();
            listener.unsubscribe();
        };
    }, []);
    return ((0, jsx_runtime_1.jsx)(navigation_context_1.default.Provider, { value: {
            push,
            pop,
        }, children: navStack.map((el, idx) => ((0, jsx_runtime_1.jsx)(View, { children: el }, idx))) }));
};
exports.NavigationProvider = NavigationProvider;
